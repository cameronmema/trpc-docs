---
title: Fastify Adapter
description: High-performance tRPC integration with Fastify web framework
icon: IconBolt
---

The Fastify adapter allows you to integrate tRPC with Fastify, a fast and low overhead web framework for Node.js with a powerful plugin system.

<Callout title="High Performance">
  Fastify is one of the fastest web frameworks for Node.js, providing excellent
  performance and a rich plugin ecosystem.
</Callout>

## Example Apps

<Cards>
  <Card
    href="https://github.com/trpc/trpc/tree/main/examples/fastify-server"
    title="Fastify Server Example"
  >
    Complete Fastify server with tRPC integration, WebSocket support, and
    Node.js client
  </Card>
  <Card
    href="https://codesandbox.io/s/github/trpc/trpc/tree/main/examples/fastify-server"
    title="CodeSandbox Demo"
  >
    Try the Fastify server example in your browser
  </Card>
</Cards>

## Installation

Install the required dependencies:

<Tabs items={['npm', 'pnpm', 'yarn', 'bun']}>
  <Tab value="npm">
    ```bash npm install @trpc/server fastify npm install -D @types/fastify ```
  </Tab>
  <Tab value="pnpm">
    ```bash pnpm add @trpc/server fastify pnpm add -D @types/fastify ```
  </Tab>
  <Tab value="yarn">
    ```bash yarn add @trpc/server fastify yarn add -D @types/fastify ```
  </Tab>
  <Tab value="bun">
    ```bash bun add @trpc/server fastify bun add -D @types/fastify ```
  </Tab>
</Tabs>

<Callout title="Optional: Validation Library" type="info">
  Zod isn't required but is recommended for input validation. Install with your
  preferred package manager.
</Callout>

## Quick Start

### 1. Create your tRPC router

Define your API procedures:

```typescript title="router.ts"
import { initTRPC } from '@trpc/server';
import { z } from 'zod';

type User = {
  id: string;
  name: string;
  bio?: string;
};

const users: Record<string, User> = {};

export const t = initTRPC.create();

export const appRouter = t.router({
  getUserById: t.procedure
    .input(z.string())
    .query(({ input }) => {
      return users[input]; // input type is string
    }),

  createUser: t.procedure
    .input(z.object({
      name: z.string().min(3),
      bio: z.string().max(142).optional(),
    }))
    .mutation(({ input }) => {
      const id = Date.now().toString();
      const user: User = { id, ...input };
      users[user.id] = user;
      return user;
    }),
});

// Export type definition of API
export type AppRouter = typeof appRouter;
```

### 2. Create context

Set up context for request-scoped data:

```typescript title="context.ts"
import { CreateFastifyContextOptions } from '@trpc/server/adapters/fastify';

export function createContext({ req, res }: CreateFastifyContextOptions) {
  const user = { name: req.headers.username ?? 'anonymous' };

  return { req, res, user };
}

export type Context = Awaited<ReturnType<typeof createContext>>;
```

### 3. Set up Fastify server with tRPC

```typescript title="server.ts"
import fastify from 'fastify';
import {
  fastifyTRPCPlugin,
  FastifyTRPCPluginOptions
} from '@trpc/server/adapters/fastify';
import { appRouter, type AppRouter } from './router';
import { createContext } from './context';

const server = fastify({
  // Increase maxParamLength for large batch requests
  maxParamLength: 5000,
  logger: true,
});

// Register tRPC plugin
await server.register(fastifyTRPCPlugin, {
  prefix: '/trpc',
  trpcOptions: {
    router: appRouter,
    createContext,
    onError({ path, error }) {
      // Report to error monitoring
      console.error(`Error in tRPC handler on path '${path}':`, error);
    },
  } satisfies FastifyTRPCPluginOptions<AppRouter>['trpcOptions'],
});

// Start server
const start = async () => {
  try {
    await server.listen({ port: 3000, host: '0.0.0.0' });
    console.log('Server listening on http://localhost:3000');
  } catch (err) {
    server.log.error(err);
    process.exit(1);
  }
};

start();
```

<Callout title="TypeScript Tip">
Use `satisfies FastifyTRPCPluginOptions<AppRouter>['trpcOptions']` to get proper TypeScript inference for the `onError` callback and other options.
</Callout>

## API Endpoints

Your tRPC procedures are available as HTTP endpoints:

| Procedure     | HTTP Method | Endpoint                        | Description                              |
| ------------- | ----------- | ------------------------------- | ---------------------------------------- |
| `getUserById` | GET         | `/trpc/getUserById?input=INPUT` | Where INPUT is a URI-encoded JSON string |
| `createUser`  | POST        | `/trpc/createUser`              | With JSON body containing the input data |

### Example requests

<Tabs items={['Query Example', 'Mutation Example']}>
  <Tab value="Query Example">
    ```bash
    # GET request for queries
    curl "http://localhost:3000/trpc/getUserById?input=\"user_123\""
    ```
    
    Response:
    ```json
    {
      "result": {
        "data": {
          "id": "user_123",
          "name": "Bilbo",
          "bio": "A hobbit from the Shire"
        }
      }
    }
    ```
  </Tab>
  <Tab value="Mutation Example">
    ```bash
    # POST request for mutations
    curl -X POST http://localhost:3000/trpc/createUser \
      -H "Content-Type: application/json" \
      -d '{"name": "Frodo Baggins", "bio": "Ring bearer"}'
    ```
    
    Response:
    ```json
    {
      "result": {
        "data": {
          "id": "1701234567890",
          "name": "Frodo Baggins",
          "bio": "Ring bearer"
        }
      }
    }
    ```
  </Tab>
</Tabs>

## WebSocket Support

Fastify adapter supports WebSockets for real-time subscriptions. You need to install the WebSocket plugin first:

```bash
npm install @fastify/websocket
```

### Enable WebSocket Support

```typescript title="server.ts"
import fastify from 'fastify';
import ws from '@fastify/websocket';
import { fastifyTRPCPlugin } from '@trpc/server/adapters/fastify';

const server = fastify({ logger: true });

// Register WebSocket plugin
await server.register(ws);

// Register tRPC plugin with WebSocket support
await server.register(fastifyTRPCPlugin, {
  prefix: '/trpc',
  useWSS: true,
  // Enable heartbeat messages to keep connection open
  keepAlive: {
    enabled: true,
    // Server ping message interval in milliseconds
    pingMs: 30000,
    // Connection is terminated if pong message is not received in this many milliseconds
    pongWaitMs: 5000,
  },
  trpcOptions: {
    router: appRouter,
    createContext,
  },
});
```

### Add Subscriptions to Your Router

```typescript title="router.ts"
export const appRouter = t.router({
  // ... existing procedures

  randomNumber: t.procedure.subscription(async function* () {
    while (true) {
      yield { randomNumber: Math.random() };
      await new Promise((resolve) => setTimeout(resolve, 1000));
    }
  }),

  onUserUpdate: t.procedure
    .input(z.object({ userId: z.string() }))
    .subscription(async function* ({ input }) {
      // Subscribe to user updates
      // Implementation depends on your event system
      yield { userId: input.userId, status: 'subscribed' };
    }),
});
```

## Advanced Configuration

### Custom Error Handling

Add comprehensive error handling:

```typescript title="server.ts"
await server.register(fastifyTRPCPlugin, {
  prefix: '/trpc',
  trpcOptions: {
    router: appRouter,
    createContext,
    onError: ({ error, path, input, ctx, type, req }) => {
      // Log the error
      server.log.error({
        error: error.message,
        path,
        input,
        type,
        stack: error.stack,
      }, 'tRPC Error');

      // Send to error monitoring
      if (error.code === 'INTERNAL_SERVER_ERROR') {
        // errorService.captureException(error);
      }
    },
  },
});
```

### CORS Configuration

Enable CORS for cross-origin requests:

```typescript title="server.ts"
import fastifyCors from '@fastify/cors';

// Register CORS plugin
await server.register(fastifyCors, {
  origin: process.env.NODE_ENV === 'production'
    ? ['https://yourdomain.com']
    : ['http://localhost:3000'],
  credentials: true,
});
```

### Rate Limiting

Add rate limiting protection:

```typescript title="server.ts"
import fastifyRateLimit from '@fastify/rate-limit';

await server.register(fastifyRateLimit, {
  max: 100,
  timeWindow: '1 minute',
  cache: 10000,
});
```

### Authentication Hook

Add authentication using Fastify hooks:

```typescript title="server.ts"
// Add authentication hook
server.addHook('preHandler', async (request, reply) => {
  if (request.url.startsWith('/trpc/protected')) {
    const authHeader = request.headers.authorization;
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      reply.code(401).send({ error: 'Unauthorized' });
      return;
    }

    // Verify token and add user to request
    const token = authHeader.slice(7);
    const user = await verifyToken(token);
    if (!user) {
      reply.code(401).send({ error: 'Invalid token' });
      return;
    }

    request.user = user;
  }
});
```

## Plugin Options

The Fastify tRPC plugin accepts these options:

| Option        | Type                     | Default     | Description                       |
| ------------- | ------------------------ | ----------- | --------------------------------- |
| `prefix`      | `string`                 | `"/trpc"`   | URL prefix for tRPC endpoints     |
| `useWSS`      | `boolean`                | `false`     | Enable WebSocket support          |
| `keepAlive`   | `object`                 | `undefined` | WebSocket keepalive configuration |
| `trpcOptions` | `NodeHTTPHandlerOptions` | Required    | tRPC handler options              |

### Keep Alive Configuration

```typescript
keepAlive: {
  enabled: true,
  // Server ping message interval in milliseconds
  pingMs: 30000,
  // Connection is terminated if pong message is not received in this many milliseconds
  pongWaitMs: 5000,
}
```

## Integration Patterns

### With Existing Fastify Apps

Add tRPC to an existing Fastify application:

```typescript title="existing-app.ts"
import fastify from 'fastify';
import { fastifyTRPCPlugin } from '@trpc/server/adapters/fastify';

const server = fastify({ logger: true });

// Existing Fastify routes
server.get('/api/health', async (request, reply) => {
  return { status: 'ok' };
});

server.register(async function userRoutes(fastify) {
  fastify.get('/users', async () => {
    return { users: [] };
  });
}, { prefix: '/api' });

// Add tRPC
await server.register(fastifyTRPCPlugin, {
  prefix: '/api/trpc',
  trpcOptions: {
    router: appRouter,
    createContext,
  },
});
```

### Environment-Based Configuration

```typescript title="config.ts"
export const config = {
  server: {
    port: parseInt(process.env.PORT || '3000'),
    host: process.env.HOST || 'localhost',
  },
  trpc: {
    prefix: process.env.TRPC_PREFIX || '/trpc',
    enableWebSocket: process.env.ENABLE_WS === 'true',
  },
  database: {
    url: process.env.DATABASE_URL,
  },
};
```

## Testing

Test your Fastify tRPC integration:

```typescript title="server.test.ts"
import { build } from './app';
import { test } from 'tap';

test('tRPC integration', async (t) => {
  const app = build();
  t.teardown(() => app.close());

  // Test query
  const queryResponse = await app.inject({
    method: 'GET',
    url: '/trpc/getUserById?input="user_123"',
  });

  t.equal(queryResponse.statusCode, 200);
  t.has(queryResponse.json(), {
    result: {
      data: {
        id: 'user_123',
        name: 'Bilbo'
      }
    }
  });

  // Test mutation
  const mutationResponse = await app.inject({
    method: 'POST',
    url: '/trpc/createUser',
    payload: {
      name: 'Test User',
      bio: 'Test bio'
    },
  });

  t.equal(mutationResponse.statusCode, 200);
  t.has(mutationResponse.json().result.data, {
    name: 'Test User',
    bio: 'Test bio'
  });
});
```

## Deployment

### Production Setup

<Accordions>
  <Accordion title="Docker Deployment">
    ```dockerfile title="Dockerfile"
    FROM node:18-alpine
    
    WORKDIR /app
    
    COPY package*.json ./
    RUN npm ci --only=production
    
    COPY . .
    RUN npm run build
    
    EXPOSE 3000
    
    CMD ["npm", "start"]
    ```
  </Accordion>
  
  <Accordion title="PM2 Configuration">
    ```json title="ecosystem.config.js"
    module.exports = {
      apps: [{
        name: 'trpc-fastify-server',
        script: './dist/server.js',
        instances: 'max',
        exec_mode: 'cluster',
        env: {
          NODE_ENV: 'production',
          PORT: 3000
        },
        error_file: './logs/err.log',
        out_file: './logs/out.log',
        log_file: './logs/combined.log',
      }]
    };
    ```
  </Accordion>
  
  <Accordion title="Health Checks">
    ```typescript
    // Add health check route
    server.get('/health', async (request, reply) => {
      const healthcheck = {
        uptime: process.uptime(),
        timestamp: Date.now(),
        status: 'OK',
        memory: process.memoryUsage(),
      };
      
      try {
        // Add database health check
        // await db.ping();
        return healthcheck;
      } catch (error) {
        healthcheck.status = 'ERROR';
        reply.code(503);
        return healthcheck;
      }
    });
    ```
  </Accordion>
</Accordions>

## Performance Tips

<Callout title="Optimization Tips">
  - Use `maxParamLength: 5000` for large batch requests - Enable `keepAlive` for
  WebSocket connections - Consider using Fastify's built-in compression plugin -
  Use Fastify's schema validation for additional performance
</Callout>

### Schema Validation

Combine tRPC validation with Fastify schemas for even better performance:

```typescript
const schema = {
  querystring: {
    type: 'object',
    properties: {
      input: { type: 'string' }
    }
  }
};

server.get('/api/custom', { schema }, async (request, reply) => {
  // Handle custom route with Fastify validation
  return { success: true };
});
```

## Next Steps

<Cards>
  <Card href="/docs/server/procedures" title="Define Procedures">
    Learn how to create queries, mutations, and subscriptions
  </Card>
  <Card href="/docs/server/websockets" title="WebSocket Guide">
    Deep dive into WebSocket subscriptions and real-time features
  </Card>
  <Card href="/docs/server/middlewares" title="Add Middleware">
    Implement authentication, logging, and custom logic
  </Card>
  <Card href="/docs/client" title="Connect Your Frontend">
    Integrate tRPC with your React, Next.js, or other frontend
  </Card>
</Cards>
